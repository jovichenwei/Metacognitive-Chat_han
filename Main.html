<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metacognitive Chat Â· TRAP Prototype (Chat + Streaming + Rich)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body { height: 100%; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }
    .typing::after { content: 'â–Œ'; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-slate-50 to-emerald-50 text-slate-900">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    /* ----------------- UI Helpers ----------------- */
    const Badge = ({ children, className = "" }) => (
      <span className={"inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium shadow-sm " + className}>{children}</span>
    );

    const Section = ({ title, subtitle, right, children }) => (
      <div className="bg-white/70 backdrop-blur rounded-2xl shadow-sm ring-1 ring-black/5 p-5">
        <div className="flex items-start justify-between gap-4">
          <div>
            <h2 className="text-lg font-semibold tracking-tight text-gray-900">{title}</h2>
            {subtitle && <p className="text-sm text-gray-600 mt-0.5">{subtitle}</p>}
          </div>
          {right}
        </div>
        <div className="mt-4">{children}</div>
      </div>
    );

    const ConfidenceBar = ({ value }) => {
      const clamped = Math.max(0, Math.min(1, value));
      const pct = Math.round(clamped * 100);
      const color = clamped > 0.85 ? "bg-emerald-500" : clamped > 0.6 ? "bg-amber-500" : "bg-rose-500";
      return (
        <div className="w-full">
          <div className="flex items-center justify-between text-xs text-gray-600 mb-1">
            <span className="inline-flex items-center gap-1">Calibrated Confidence
              <span className="inline-flex items-center justify-center h-4 w-4 rounded-full bg-slate-200 text-[10px] text-slate-700" title="Confidence ç¶“ isotonic æ¨¡å‹æ ¡æº–ï¼›æŒ‡æ¨™ï¼šECE/Brier åƒ…ç¤ºæ„ã€‚">?</span>
            </span>
            <span className="font-medium text-gray-800">{pct}%</span>
          </div>
          <div className="h-2.5 w-full rounded-full bg-gray-100 overflow-hidden ring-1 ring-inset ring-black/5">
            <div className={`h-full ${color} transition-all`} style={{ width: `${pct}%` }} />
          </div>
          <p className="text-[10px] text-gray-500 mt-1">ECE 2.8% Â· Brier 0.12ï¼ˆç¤ºæ„ï¼‰</p>
        </div>
      );
    };

    const Pill = ({ label, score }) => {
      const color = score > 0.85 ? "text-emerald-700 bg-emerald-50 ring-emerald-200" : score > 0.6 ? "text-amber-700 bg-amber-50 ring-amber-200" : "text-rose-700 bg-rose-50 ring-rose-200";
      const pct = Math.round(score * 100);
      return <div className={`rounded-xl ring-1 px-2.5 py-1 text-xs font-medium ${color}`}>{label}: {pct}%</div>;
    };

    const Step = ({ idx, title, status }) => {
      const colors = { done: "bg-emerald-100 text-emerald-800 ring-emerald-200", active: "bg-blue-100 text-blue-800 ring-blue-200 animate-pulse", pending: "bg-gray-100 text-gray-700 ring-gray-200" };
      return (
        <div className="flex items-start gap-3">
          <div className={`h-6 w-6 rounded-full grid place-items-center text-xs font-bold ring-1 ${colors[status]}`}>{idx}</div>
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <p className="text-sm font-medium text-gray-900">{title}</p>
            </div>
            <div className="mt-1 h-[3px] w-full rounded-full bg-gray-100 overflow-hidden">
              <div className={`h-full ${status === "done" ? "bg-emerald-500" : status === "active" ? "bg-blue-500" : "bg-gray-300"}`} style={{ width: status === "done" ? "100%" : status === "active" ? "60%" : "10%" }} />
            </div>
          </div>
        </div>
      );
    };

    const EvidenceCard = ({ title, url, date, trust = 0.9, supports = [] }) => {
      const pct = Math.round(trust * 100);
      const color = trust > 0.85 ? "text-emerald-700 bg-emerald-50 ring-emerald-200" : trust > 0.6 ? "text-amber-700 bg-amber-50 ring-amber-200" : "text-rose-700 bg-rose-50 ring-rose-200";
      return (
        <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/60">
          <div className="flex items-center justify-between">
            <a href={url} target="_blank" rel="noreferrer" className="text-sm font-medium text-blue-700 hover:underline">{title}</a>
            <span className={`text-[10px] px-2 py-0.5 rounded-full ring-1 ${color}`}>trust {pct}%</span>
          </div>
          <p className="text-[11px] text-gray-500 mt-1">Checked: {date}</p>
          {supports.length > 0 && (
            <div className="mt-2 flex flex-wrap gap-1 text-[10px]">
              {supports.map((s,i)=> (
                <span key={i} className="px-1.5 py-0.5 rounded-md bg-slate-100 text-slate-700 ring-1 ring-slate-200">supports {s}</span>
              ))}
            </div>
          )}
        </div>
      );
    };

    const Radar = ({ values = [0.8, 0.7, 0.6, 0.9, 0.75], labels = ["Clarity","Freshness","Coverage","Consistency","Noise"] }) => {
      const size = 160, cx = size/2, cy = size/2, r = 60, n = values.length;
      const angle = (i) => (Math.PI * 2 * i) / n - Math.PI/2;
      const pts = values.map((v, i) => [cx + Math.cos(angle(i)) * r * v, cy + Math.sin(angle(i)) * r * v]);
      const outline = Array.from({length:n}, (_,i)=>[cx + Math.cos(angle(i)) * r, cy + Math.sin(angle(i)) * r]);
      return (
        <div className="flex items-center gap-4">
          <svg width={size} height={size} className="shrink-0">
            <circle cx={cx} cy={cy} r={r} className="fill-none stroke-gray-200" />
            {[0.25,0.5,0.75].map((t,i)=> (
              <circle key={i} cx={cx} cy={cy} r={r*t} className="fill-none stroke-gray-100" />
            ))}
            {outline.map((p,i)=> (
              <line key={i} x1={cx} y1={cy} x2={p[0]} y2={p[1]} className="stroke-gray-200" />
            ))}
            <polygon points={pts.map(p=>p.join(",")).join(" ")} className="fill-blue-500/30 stroke-blue-600" />
          </svg>
          <div className="grid grid-cols-1 gap-1 text-[12px] text-gray-700">
            {labels.map((l,i)=> (
              <div key={l} className="flex items-center gap-2">
                <span className="h-1.5 w-8 rounded-full bg-blue-500/60" />
                <span className="w-28">{l}</span>
                <span className="tabular-nums text-gray-900 font-medium">{Math.round(values[i]*100)}%</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // --- Compact pro widgets for TRAP ---
    const MetricRow = ({label, value, hint}) => (
      <div className="flex items-center justify-between text-[12px]">
        <span className="text-gray-600">{label}</span>
        <div className="flex items-center gap-2">
          {hint && <span className="text-[10px] text-gray-400">{hint}</span>}
          <span className="font-medium tabular-nums">{value}</span>
        </div>
      </div>
    );

    const JSONBlock = ({obj}) => (
      <pre className="text-[11px] leading-relaxed bg-slate-900 text-slate-100 rounded-xl p-3 overflow-auto ring-1 ring-black/10">{JSON.stringify(obj, null, 2)}</pre>
    );

    const Dot = ({status='ok',label}) => {
      const map = { ok: 'bg-emerald-500', warn: 'bg-amber-500', error: 'bg-rose-500' };
      return (
        <span className="inline-flex items-center gap-1 text-[11px]">
          <span className={`inline-block h-2.5 w-2.5 rounded-full ${map[status]||map.ok}`} />
          {label && <span className="text-gray-700">{label}</span>}
        </span>
      );
    };

    const RankingBar = ({rows}) => {
      const max = Math.max(...rows.map(r=>r.total));
      return (
        <div className="space-y-1">
          {rows.sort((a,b)=>b.total-a.total).map(r=> (
            <div key={r.name} className="flex items-center gap-2 text-[12px]">
              <div className="w-16 shrink-0 text-gray-700">{r.name}</div>
              <div className="flex-1 h-2 rounded-full bg-gray-100 ring-1 ring-black/5 overflow-hidden">
                <div className="h-full bg-indigo-500" style={{width: `${(r.total/max)*100}%`}} />
              </div>
              <div className="w-14 text-right tabular-nums font-medium">{r.total.toFixed(3)}</div>
            </div>
          ))}
        </div>
      );
    };

    const Spark = ({values=[0.3,0.3,0.3]}) => {
      const w=60,h=18,p=2; // tiny sparkline
      const xs = values.map((_,i)=> p + (i*(w-2*p))/(values.length-1));
      const ys = values.map(v=> h - (p + v*(h-2*p)));
      const points = xs.map((x,i)=> `${x},${ys[i]}`).join(' ');
      return (
        <svg width={w} height={h} className="shrink-0">
          <polyline points={points} fill="none" stroke="currentColor" strokeWidth="1" className="text-indigo-600"/>
        </svg>
      );
    };

    const CityTable = ({weights, rows}) => (
      <div className="overflow-hidden rounded-xl ring-1 ring-black/5">
        <div className="grid grid-cols-6 text-[12px] bg-slate-50 px-3 py-2 font-medium text-gray-700">
          <div>åŸå¸‚</div><div>ClimateÃ—{weights.climate}</div><div>BudgetÃ—{weights.budget}</div><div>ActivityÃ—{weights.activity}</div><div>Total</div><div className="text-right pr-2">Mix</div>
        </div>
        {rows.map((r,i)=> (
          <div key={i} className="grid grid-cols-6 text-[12px] px-3 py-2 border-t border-gray-100 items-center">
            <div className="font-medium text-gray-900">{r.name}</div>
            <div>{(r.climate*weights.climate).toFixed(3)} <span className="text-gray-400">({r.climate.toFixed(2)})</span></div>
            <div>{(r.budget*weights.budget).toFixed(3)} <span className="text-gray-400">({r.budget.toFixed(2)})</span></div>
            <div>{(r.activity*weights.activity).toFixed(3)} <span className="text-gray-400">({r.activity.toFixed(2)})</span></div>
            <div className="font-semibold">{r.total.toFixed(3)}</div>
            <div className="flex justify-end"><Spark values={[r.climate, r.budget, r.activity]} /></div>
          </div>
        ))}
      </div>
    );

    const Tabs = ({tabs}) => {
      const [i, setI] = React.useState(0);
      return (
        <div>
          <div className="flex flex-wrap gap-2">
            {tabs.map((t,idx)=> (
              <button key={t.label} onClick={()=>setI(idx)} className={`px-2.5 py-1 rounded-lg text-[12px] ring-1 ${i===idx? 'bg-slate-900 text-white ring-slate-900':'bg-white text-slate-700 ring-black/10 hover:bg-slate-50'}`}>{t.label}</button>
            ))}
          </div>
          <div className="mt-3">{tabs[i].content}</div>
        </div>
      );
    };

    /* ----------------- Chat pieces ----------------- */
    const Bubble = ({ role, children, isTyping, onClick }) => {
      const isUser = role === 'user';
      return (
        <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} w-full`}>
          <div onClick={onClick} className={`max-w-[80%] rounded-2xl px-4 py-2 text-sm shadow-sm ring-1 ${isUser ? 'bg-indigo-600 text-white ring-indigo-500' : 'bg-white/80 ring-black/5 text-gray-900'} ${onClick ? 'cursor-pointer' : ''}`}>
            <span className={isTyping ? 'typing' : ''} style={{ whiteSpace: 'pre-wrap' }}>{children}</span>
          </div>
        </div>
      );
    };

    function generateAssistantMeta(revision = false) {
      const common = {
        weights: { climate: 0.45, budget: 0.30, activity: 0.25 },
        formula: "total = 0.45Ã—S_climate + 0.30Ã—S_budget + 0.25Ã—S_activity",
        calibration: { method: 'Isotonic (simulated)', ece: 0.028, brier: 0.12 },
        uncertainty: { data: 0.25, model: 0.15, noise: 0.10 },
        pipeline: [
          'Parse intent â†’ æ—…éŠè¦åŠƒ(11æœˆ) with constraints',
          'Collect climatology & price priors (2019â€“2025 window)',
          'Normalize metrics â†’ [0,1] via city-wise minâ€“max',
          'Score using weighted sum (see formula)',
          'Calibrate confidence via isotonic mapping',
          'Derive triggers for reâ€‘perception & humanâ€‘inâ€‘loop'
        ],
        triggers: [
          'Î”Temp between sources > 1.5Â°C',
          'Missing data coverage > 20% for any city',
          'Confidence < 0.6 or ECE > 0.05'
        ],
        assumptions: [
          'å‡ºç™¼åœ°ç›¸åŒä¸”ç‚ºç¶“æ¿Ÿè‰™å‡å€¼',
          'ä½å®¿ç­‰ç´šç‚ºä¸­éšæ—…å®¿ (3â˜…â€“3.5â˜…)',
          'æ´»å‹•å¯†åº¦ä»¥æ­¥è¡Œå¯é”æ™¯é»/é¤¨èˆæ•¸è¿‘ä¼¼'
        ]
      };

      if (!revision) {
        return {
          ...common,
          conf: 0.78,
          city: 'æ±äº¬',
          temps: { Tokyo: '20 / 12â€“14Â°C', Rome: '17 / 10â€“12Â°C', Seoul: '10â€“15Â°C' },
          reasons: [
            { title: 'è’é›†æ­·å²æ°£å€™è³‡æ–™', status: 'done' },
            { title: 'æ¯”è¼ƒèˆ’é©åº¦èˆ‡é™é›¨', status: 'active' },
            { title: 'æ•´åˆé ç®—èˆ‡è¡Œç¨‹', status: 'pending' },
          ],
          perception: { clarity: 0.82, freshness: 0.72, coverage: 0.68, consistency: 0.74, noise: 0.88 },
          sources: [
            { t: 'WeatherSpark 2015â€“2023', d: '2025-10-12', u: 'https://weatherspark.com', trust: 0.87, supports: ['climate'] },
            { t: 'Meteostat Climatology', d: '2025-10-09', u: 'https://meteostat.net', trust: 0.84, supports: ['climate'] },
            { t: 'Expedia Avg Fare (2019â€“2024)', d: '2025-10-10', u: 'https://www.expedia.com', trust: 0.83, supports: ['budget'] },
          ],
          cityScores: [
            { name: 'æ±äº¬', climate: 0.80, budget: 0.62, activity: 0.88 },
            { name: 'ç¾…é¦¬', climate: 0.76, budget: 0.69, activity: 0.86 },
            { name: 'é¦–çˆ¾', climate: 0.70, budget: 0.75, activity: 0.72 }
          ].map(c => ({ ...c, total: +(0.45*c.climate + 0.30*c.budget + 0.25*c.activity).toFixed(3) })),
          confidence_factors: [
            { label: 'å¹´ä»½ä¸€è‡´æ€§', value: 'ä¸­', note: 'ä¾†æºå¹´ä»½ 2015â€“2023ï¼ˆéå®Œå…¨å°é½Šï¼‰' },
            { label: 'ä¾†æºåˆ†æ­§', value: 'ä½', note: 'å…©ä¾†æºæº«å·® < 1.0Â°C' },
            { label: 'ç¼ºè£œç‡', value: 'ä½', note: 'ç¼ºå¤± < 10%' }
          ],
          triggersFired: { deltaTemp: false, missing: false, lowConfidence: false },
          reflection: 'æ±äº¬çœ‹ä¼¼æœ€èˆ’é©ï¼Œä½†æ±äº¬æ•¸æ“šå¹´ä»½åˆ†æ•£ï¼Œä¿¡å¿ƒä¸‹èª¿ 10%ã€‚å»ºè­°å‡ºç™¼å‰å†æ¬¡æ ¸å°è¿‘ä¸‰å¹´è³‡æ–™ã€‚'
        };
      }
      return {
        ...common,
        conf: 0.91,
        city: 'ç¾…é¦¬',
        temps: { Tokyo: '15â€“17 / 10â€“12Â°C', Rome: '17 / 10â€“12Â°C', Seoul: '10â€“15Â°C' },
        reasons: [
          { title: 'é‡æ–°æŠ“å– 2019â€“2025 åŒæœŸè³‡æ–™', status: 'done' },
          { title: 'ä¸€è‡´æ€§æª¢æŸ¥ï¼ˆä¾†æºäº¤å‰æ¯”å°ï¼‰', status: 'done' },
          { title: 'é‡æ–°è¨ˆç®—èˆ’é©æŒ‡æ•¸èˆ‡é ç®—', status: 'active' },
        ],
        perception: { clarity: 0.92, freshness: 0.86, coverage: 0.78, consistency: 0.89, noise: 0.93 },
        sources: [
          { t: 'WeatherSpark 2019â€“2025', d: '2025-10-15', u: 'https://weatherspark.com', trust: 0.95, supports: ['climate'] },
          { t: 'Meteostat Monthly Normals', d: '2025-10-15', u: 'https://meteostat.net', trust: 0.9, supports: ['climate'] },
          { t: 'Expedia Avg Fare (2019â€“2025)', d: '2025-10-14', u: 'https://www.expedia.com', trust: 0.88, supports: ['budget'] },
        ],
        cityScores: [
          { name: 'æ±äº¬', climate: 0.74, budget: 0.60, activity: 0.87 },
          { name: 'ç¾…é¦¬', climate: 0.82, budget: 0.73, activity: 0.84 },
          { name: 'é¦–çˆ¾', climate: 0.68, budget: 0.76, activity: 0.71 }
        ].map(c => ({ ...c, total: +(0.45*c.climate + 0.30*c.budget + 0.25*c.activity).toFixed(3) })),
        confidence_factors: [
          { label: 'å¹´ä»½ä¸€è‡´æ€§', value: 'é«˜', note: 'ä¾†æºæ™‚é–“çª— 2019â€“2025 å°é½Š' },
          { label: 'ä¾†æºåˆ†æ­§', value: 'ä½', note: 'å…©ä¾†æºæº«å·® < 0.6Â°C' },
          { label: 'ç¼ºè£œç‡', value: 'ä½', note: 'ç¼ºå¤± < 5%' }
        ],
        triggersFired: { deltaTemp: false, missing: false, lowConfidence: false },
        reflection: 'ä¿®æ­£åŸå› ï¼šæ±äº¬åŸå§‹æ¨£æœ¬æ··å…¥ä¸ä¸€è‡´çš„å¹´ä»½ï¼Œå°è‡´åé«˜ã€‚å·²çµ±ä¸€æ™‚é–“çª—ä¸¦å†é©—è­‰ï¼Œçµè«–æ”¹ç‚ºç¾…é¦¬æœ€ä½³ã€‚'
      };
    }

    function formatRichReply(meta, userInput) {
      const when = new Date().toLocaleString();
      return (
`ã€æ‘˜è¦ã€‘\n${meta.city} æœ€ç¬¦åˆä½ çš„æ¢ä»¶ï¼ˆèˆ’é©åº¦ã€é ç®—ã€æ´»å‹•å¤šæ¨£ï¼‰ã€‚ç›®å‰è‡ªä¿¡åº¦ï¼š${Math.round(meta.conf*100)}%ã€‚\n\n`+
`ã€ç‚ºä»€éº¼ã€‘\n1. æ°£å€™èˆ’é©ï¼š11 æœˆæ—¥å¤œæº«ç´„ ${meta.temps.Rome}ï¼ˆç¾…é¦¬ï¼‰/ ${meta.temps.Tokyo}ï¼ˆæ±äº¬ï¼‰/ ${meta.temps.Seoul}ï¼ˆé¦–çˆ¾ï¼‰ï¼›è½åœ¨ 12â€“22Â°C å€é–“æ¯”ä¾‹è¼ƒé«˜ã€‚\n2. é ç®—è©•ä¼°ï¼šæ©Ÿç¥¨èˆ‡ä½å®¿å‡åƒ¹åœ¨å¯æ¥å—å€é–“ï¼ˆä»¥ 2019â€“2025 å¹³å‡ç‚ºåŸºæº–ï¼‰ã€‚\n3. æ´»å‹•å¯†åº¦ï¼šåŸå¸‚æ­¥è¡Œå‹å–„ã€åšç‰©é¤¨èˆ‡ç¾é£Ÿå¯†é›†åº¦é«˜ï¼Œé›¨å¤©æ›¿ä»£æ–¹æ¡ˆå¤šã€‚\n\n`+
`ã€è¡Œç¨‹è‰æ¡ˆï¼ˆ3 æ—¥ï¼‰ã€‘\nDay 1ï¼šæŠµé”èˆ‡å¸‚ä¸­å¿ƒæ­¥è¡Œè·¯ç·š â†’ å‚æ™šåœ°æ¨™ï¼›æ™šé¤æ¨è–¦åœ¨åœ°ç‰¹è‰²é¤é¤¨ã€‚\nDay 2ï¼šä¸Šåˆåšç‰©é¤¨/æˆ¶å¤–æ™¯é» â†’ ä¸‹åˆå’–å•¡æ–‡åŒ–æ¢è¨ª â†’ å¤œé–“æ•£æ­¥èˆ‡ç”œé»ã€‚\nDay 3ï¼šè¿‘éƒŠåŠæ—¥éŠæˆ–å¸‚å ´æ¡è²· â†’ ä¸‹åˆè¿”å›ã€‚\n\n`+
`ã€é ç®—ç²—ä¼°ã€‘\nèˆªç­ï¼šä»¥å¹³å‡ç¥¨åƒ¹å€é–“ä¼°ç®—ï¼›ä½å®¿ï¼šä¸­ç­‰æ—…å®¿ 2 æ™šï¼›é¤é£²èˆ‡äº¤é€šï¼šä¾åŸå¸‚å‡åƒ¹è¨ˆã€‚å¯¦éš›åƒ¹æ ¼æœƒå› å‡ºç™¼åœ°èˆ‡æ™‚é–“æ³¢å‹•ã€‚\n\n`+
`ã€ä¾æ“šèˆ‡é™åˆ¶ã€‘\n- ä¾æ“šï¼š${meta.sources.map(s=>s.t).join('ã€')}ï¼ˆç¤ºç¯„è³‡æ–™ï¼‰ã€‚\n- é™åˆ¶ï¼šæ­·å²å‡å€¼ä¸å«çªç™¼æ°£å€™ï¼›è‹¥éœ€æ›´ç²¾æº–ï¼Œå»ºè­°åŠ å…¥åˆ†ä½æ•¸èˆ‡å³æ™‚å¤©æ°£ã€‚\n\n`+
`ã€TRAP æ‘˜è¦ã€‘\nPerceptionï¼šClarity ${Math.round(meta.perception.clarity*100)}%ã€Freshness ${Math.round(meta.perception.freshness*100)}%ã€‚\nReasoningï¼š${meta.reasons.map((r,i)=>`${i+1}.${r.title}`).join(' / ')}ã€‚\nTransparencyï¼šä¾†æºå¯ä¿¡åº¦åˆ†ä½ˆè¦‹å³å´å¡ç‰‡ã€‚\nAdaptationï¼šè‹¥è³‡æ–™å¹´ä»½ä¸ä¸€è‡´ï¼Œå•Ÿå‹•çµ±ä¸€æ™‚é–“çª—ï¼›Confidence < 60% æ™‚å»ºè­°å†æ„ŸçŸ¥/äººå¯©ã€‚\n\n`+
`ã€æ™‚é–“æˆ³ã€‘${when}\n`)
    }

    function App() {
      const [messages, setMessages] = useState([
        { id: 1, role: 'assistant', text: 'å—¨ï¼å‘Šè¨´æˆ‘ä½ çš„æ¢ä»¶ï¼šæ°£å€™ã€é ç®—ã€æ´»å‹•åå¥½ï¼Œæˆ‘æœƒå¹«ä½ æ¨è–¦ã€‚' }
      ]);
      const [input, setInput] = useState('11 æœˆå»æ—…éŠï¼šæ±äº¬/é¦–çˆ¾/ç¾…é¦¬ï¼Œæ¢ä»¶ï¼æ°£å€™èˆ’é© + é ç®—åˆç† + æ´»å‹•å¤šæ¨£ï¼Ÿ');
      const [version, setVersion] = useState(1);
      const [selectedIdx, setSelectedIdx] = useState(null);
      const [isStreaming, setIsStreaming] = useState(false);
      const [speed, setSpeed] = useState('fast'); // slow | normal | fast
      const chatEndRef = useRef(null);

      // ğŸ”’ å›ºå®šç•«é¢ï¼šç§»é™¤è‡ªå‹•æ²å‹•ï¼ˆè‹¥è¦æ¢å¾©ï¼Œè«‹åƒè€ƒä¸‹æ–¹è¨»è§£ï¼‰
      // useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isStreaming]);
      // æˆ–ï¼šåªåœ¨è¨Šæ¯å®Œæˆå¾Œæ²å‹•
      // useEffect(() => { if (!isStreaming) chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

      const lastAssistantWithMeta = React.useMemo(() => {
        for (let i = messages.length - 1; i >= 0; i--) {
          if (messages[i].role === 'assistant' && messages[i].meta) return i;
        }
        return null;
      }, [messages]);

      const speedInterval = React.useMemo(() => ({ slow: 48, normal: 28, fast: 14 })[speed] || 48, [speed]);

      // Streaming utility for a specific message index
      const streamMessageText = (index, fullText, onDone) => {
        setIsStreaming(true);
        let i = 0;
        const id = setInterval(() => {
          i++;
          setMessages((m) => m.map((msg, idx) => idx === index ? { ...msg, text: fullText.slice(0, i), isTyping: i < fullText.length } : msg));
          if (i >= fullText.length) {
            clearInterval(id);
            setMessages((m) => m.map((msg, idx) => idx === index ? { ...msg, isTyping: false } : msg));
            setIsStreaming(false);
            onDone && onDone();
          }
        }, speedInterval);
      };

      const send = () => {
        if (!input.trim() || isStreaming) return;
        const userTurn = { id: Date.now(), role: 'user', text: input.trim() };
        setMessages((m) => [...m, userTurn]);
        setInput('');

        // create assistant placeholder + meta
        const meta = generateAssistantMeta(false);
        const replyFull = formatRichReply(meta, userTurn.text);
        const botTurn = { id: Date.now() + 1, role: 'assistant', text: '', meta };
        const newIndex = messages.length + 1; // where bot will be
        setMessages((m) => [...m, botTurn]);
        setVersion((v) => v + 1);
        setSelectedIdx(newIndex);
        streamMessageText(newIndex, replyFull);
      };

      const challenge = () => {
        if (isStreaming) return;
        const idx = lastAssistantWithMeta;
        if (idx == null) return;
        const meta = generateAssistantMeta(true);
        const revised = formatRichReply(meta, messages[idx - 1]?.text || '');
        // replace meta + restart streaming text
        setMessages((m) => m.map((msg, i) => i === idx ? { ...msg, text: '', meta } : msg));
        setVersion((v) => v + 1);
        setSelectedIdx(idx);
        streamMessageText(idx, revised);
      };

      const meta = selectedIdx != null && messages[selectedIdx]?.meta ? messages[selectedIdx].meta : (lastAssistantWithMeta != null ? messages[lastAssistantWithMeta].meta : null);

      return (
        <div className="mx-auto max-w-6xl px-4 py-6 lg:py-8">
          {/* Header */}
          <header className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 grid place-items-center rounded-2xl bg-indigo-600 text-white font-bold shadow-sm">MC</div>
              <div>
                <h1 className="text-xl sm:text-2xl font-semibold tracking-tight">Metacognitive Chat Â· TRAP Prototype</h1>
                <p className="text-xs sm:text-sm text-gray-600">ç‰ˆæœ¬ v{version} Â· ï¼ˆç¤ºç¯„ï¼‰</p>
              </div>
            </div>
            <div className="flex items-center gap-2 flex-wrap justify-end">
              <label className="text-xs text-gray-600">è¼¸å‡ºé€Ÿåº¦</label>
              <select className="rounded-lg border border-gray-300 text-xs px-2 py-1 bg-white" value={speed} onChange={(e)=>setSpeed(e.target.value)}>
                <option value="slow">æ…¢</option>
                <option value="normal">ä¸­</option>
                <option value="fast">å¿«</option>
              </select>
              <Badge className="bg-indigo-600 text-white">Chat + Streaming + Rich</Badge>
            </div>
          </header>

          {/* ä¸»çµè«– Ribbon */}
          {meta && (
            <div className="mt-3 rounded-2xl bg-gradient-to-r from-indigo-600 to-emerald-600 text-white ring-1 ring-black/5 p-3 flex items-center justify-between flex-wrap gap-2">
              <div className="flex items-center gap-2">
                <span className="text-xs uppercase tracking-wide bg-white/20 px-2 py-0.5 rounded-md">Topâ€‘1</span>
                <span className="text-sm sm:text-base font-semibold">{meta.city}</span>
              </div>
              <div className="flex items-center gap-2 text-xs sm:text-sm">
                <span className="opacity-90">Confidence</span>
                <span className="font-semibold">{Math.round(meta.conf*100)}%</span>
              </div>
            </div>
          )}

          {/* Main grid */}
          <div className="mt-6 grid grid-cols-1 lg:grid-cols-5 gap-5">
            {/* Chat Column */}
            <div className="lg:col-span-3 flex flex-col rounded-2xl bg-white/60 ring-1 ring-black/5 min-h-[70vh]">
              <div className="px-4 pt-4 pb-2 border-b border-black/5 flex items-center justify-between">
                <p className="text-sm text-gray-700">å°è©±</p>
                <div className="text-[11px] text-gray-500">é»é¸ AI å›åˆå¯åœ¨å³å´æŸ¥çœ‹ TRAP ç´°ç¯€</div>
              </div>
              <div className="flex-1 overflow-auto p-4 space-y-3">
                {messages.map((m, i) => (
                  <Bubble key={m.id ?? i} role={m.role} isTyping={!!m.isTyping} onClick={() => m.role==='assistant' && m.meta && setSelectedIdx(i)}>
                    {m.text}
                  </Bubble>
                ))}
                <div ref={chatEndRef} />
              </div>
              <div className="p-3 border-t border-black/5">
                <div className="flex gap-2">
                  <input className="flex-1 rounded-xl border border-gray-200 bg-white px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" value={input} onChange={(e)=>setInput(e.target.value)} placeholder="è¼¸å…¥ä½ çš„ä»»å‹™æˆ–å•é¡Œâ€¦" />
                  <button onClick={send} disabled={isStreaming} className={`rounded-xl px-4 py-2.5 text-sm font-medium text-white shadow-sm ${isStreaming ? 'bg-gray-400' : 'bg-indigo-600 hover:bg-indigo-700'}`}>{isStreaming ? 'ç”Ÿæˆä¸­â€¦' : 'é€å‡º'}</button>
                  <button onClick={challenge} disabled={isStreaming} className={`rounded-xl px-4 py-2.5 text-sm font-medium text-white shadow-sm ${isStreaming ? 'bg-gray-400' : 'bg-amber-600 hover:bg-amber-700'}`}>è³ªç–‘â†’å†é©—è­‰</button>
                </div>
              </div>
            </div>

            {/* Meta Column (TRAP for selected assistant turn) */}
            <div className="lg:col-span-2 space-y-5">
              {meta ? (
                <>
                  <Section title="Perception" subtitle="æ¨¡å‹å°è¼¸å…¥çš„ç†è§£èˆ‡é™åˆ¶ (g(x))" right={
                    <div className="flex items-center gap-2">
                      <Pill label="Clarity" score={meta.perception.clarity} />
                      <Pill label="Freshness" score={meta.perception.freshness} />
                    </div>
                  }>
                    <div className="flex items-center gap-2 flex-wrap text-xs">
                      <Badge className="bg-blue-50 text-blue-700 ring-1 ring-blue-200">ä¸»é¡Œï¼šæ—…éŠè¦åŠƒ</Badge>
                      <Badge className="bg-sky-50 text-sky-700 ring-1 ring-sky-200">æ¢ä»¶ï¼šæ°£å€™ / é ç®— / æ´»å‹•</Badge>
                      <Badge className="bg-fuchsia-50 text-fuchsia-700 ring-1 ring-fuchsia-200">åœ°é»ï¼šæ±äº¬ / é¦–çˆ¾ / ç¾…é¦¬</Badge>
                      <Badge className="bg-amber-50 text-amber-700 ring-1 ring-amber-200">é™åˆ¶ï¼šè³‡æ–™å¹´ä»½ä¸€è‡´æ€§</Badge>
                    </div>
                    <div className="mt-4">
                      <Radar values={[meta.perception.clarity, meta.perception.freshness, meta.perception.coverage, meta.perception.consistency, meta.perception.noise]} />
                    </div>
                  </Section>

                  <Section title="Reasoning Trace" subtitle="æ€è€ƒè·¯å¾‘èˆ‡ç‹€æ…‹ (f)">
                    <div className="space-y-4">
                      {meta.reasons.map((r, i) => (
                        <Step key={i} idx={i + 1} title={r.title} status={r.status} />
                      ))}
                    </div>
                  </Section>

                  <Section title="Output & Transparency" subtitle="çµè«–ã€ä¾æ“šèˆ‡æ ¡æº–ç½®ä¿¡åº¦ (g(f(x), Î¸))" right={<div className="w-48"><ConfidenceBar value={meta.conf} /></div>}>
                    <div className="rounded-2xl ring-1 ring-black/5 p-4 bg-white/70">
                      <div className="flex items-start justify-between gap-3">
                        <div>
                          <p className="text-xs text-gray-500">çµè«–</p>
                          <p className="text-base font-semibold mt-1">{meta.city} æœ€é©åˆ 11 æœˆæ—…éŠ</p>
                          <p className="text-sm text-gray-700 mt-2">æº«åº¦ï¼ˆæ—¥/å¤œï¼‰ï¼šæ±äº¬ {meta.temps.Tokyo} Â· ç¾…é¦¬ {meta.temps.Rome} Â· é¦–çˆ¾ {meta.temps.Seoul}</p>
                        </div>
                        <details className="text-[12px]">
                          <summary className="cursor-pointer select-none px-2 py-1 rounded-md bg-slate-100 ring-1 ring-slate-200 text-slate-700">Confidence Breakdown</summary>
                          <div className="mt-2 space-y-1">
                            {meta.confidence_factors.map((f,i)=> (
                              <div key={i} className="flex items-center justify-between gap-2">
                                <span className="text-gray-600">{f.label}</span>
                                <span className="font-medium">{f.value}</span>
                              </div>
                            ))}
                          </div>
                        </details>
                      </div>
                    </div>

                    <div className="mt-3 rounded-2xl ring-1 ring-black/5 p-4 bg-white/70">
                      <p className="text-xs text-gray-500 mb-2 inline-flex items-center gap-1">ç¶œåˆæ’å <span className="inline-flex items-center justify-center h-4 w-4 rounded-full bg-slate-200 text-[10px] text-slate-700" title="ä¾ total = 0.45Ã—Climate + 0.30Ã—Budget + 0.25Ã—Activity åŠ æ¬Šæ’åº">?</span></p>
                      <RankingBar rows={meta.cityScores} />
                    </div>

                    <div className="mt-4 grid sm:grid-cols-2 gap-3">
                      {meta.sources.map((s, i) => (
                        <EvidenceCard key={i} title={s.t} url={s.u} date={s.d} trust={s.trust} supports={s.supports || []} />
                      ))}
                    </div>

                    <div className="mt-4 flex flex-wrap gap-3 text-[12px]">
                      <div className="rounded-xl ring-1 ring-black/5 p-2.5 bg-white/70 flex items-center gap-2">
                        <Dot status={meta.triggersFired.deltaTemp ? 'warn' : 'ok'} label="ä¾†æºæº«å·®" />
                        <Dot status={meta.triggersFired.missing ? 'warn' : 'ok'} label="ç¼ºè£œç‡" />
                        <Dot status={meta.triggersFired.lowConfidence ? 'error' : 'ok'} label="ä¿¡å¿ƒé–€æª»" />
                      </div>
                    </div>
                  </Section>

                  <Section title="TRAP Logic Derivation" subtitle="ï¼ˆåˆ†é  / æ‘ºç–Šï¼‰">
                    <Tabs tabs={[
                      { label: 'Overview', content: (
                        <div className="grid sm:grid-cols-2 gap-3">
                          <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                            <p className="text-xs text-gray-500">Formula</p>
                            <p className="text-sm font-medium text-gray-900 mt-0.5">{meta.formula}</p>
                          </div>
                          <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                            <p className="text-xs text-gray-500">Weights</p>
                            <div className="flex gap-2 text-[12px]"><Badge className="bg-blue-50 text-blue-700 ring-1 ring-blue-200">Climate {meta.weights.climate}</Badge><Badge className="bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200">Budget {meta.weights.budget}</Badge><Badge className="bg-fuchsia-50 text-fuchsia-700 ring-1 ring-fuchsia-200">Activity {meta.weights.activity}</Badge></div>
                          </div>
                        </div>
                      )},
                      { label: 'Scores', content: (
                        <div className="space-y-3">
                          <CityTable weights={meta.weights} rows={meta.cityScores} />
                          <details className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                            <summary className="cursor-pointer text-[12px] text-gray-700">Machineâ€‘readable JSON</summary>
                            <div className="mt-2"><JSONBlock obj={{ weights: meta.weights, scores: meta.cityScores }} /></div>
                          </details>
                        </div>
                      )},
                      { label: 'Calibration', content: (
                        <div className="grid sm:grid-cols-3 gap-3">
                          <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70"><MetricRow label="Method" value={meta.calibration.method} /><MetricRow label="ECE" value={(meta.calibration.ece*100).toFixed(1)+'%'} hint="Expected Calibration Error" /><MetricRow label="Brier" value={meta.calibration.brier.toFixed(3)} /></div>
                          <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70"><p className="text-xs text-gray-500 mb-1">Uncertainty</p><div className="grid grid-cols-3 gap-2 text-[12px]"><div className="rounded-lg bg-slate-50 ring-1 ring-slate-200 p-2"><span className="text-gray-600">Data</span><div className="font-semibold">{Math.round(meta.uncertainty.data*100)}%</div></div><div className="rounded-lg bg-slate-50 ring-1 ring-slate-200 p-2"><span className="text-gray-600">Model</span><div className="font-semibold">{Math.round(meta.uncertainty.model*100)}%</div></div><div className="rounded-lg bg-slate-50 ring-1 ring-slate-200 p-2"><span className="text-gray-600">Noise</span><div className="font-semibold">{Math.round(meta.uncertainty.noise*100)}%</div></div></div></div>
                          <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70"><p className="text-xs text-gray-500 mb-1">Confidence</p><ConfidenceBar value={meta.conf} /></div>
                        </div>
                      )},
                      { label: 'Pipeline', content: (
                        <div className="space-y-3">
                          <details className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70" open>
                            <summary className="cursor-pointer text-[12px] text-gray-700">Steps</summary>
                            <ol className="mt-2 list-decimal pl-4 text-[12px] text-gray-800 space-y-1">{meta.pipeline.map((s,i)=> <li key={i}>{s}</li>)}</ol>
                          </details>
                          <details className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                            <summary className="cursor-pointer text-[12px] text-gray-700">Assumptions & Triggers</summary>
                            <ul className="mt-2 list-disc pl-4 text-[12px] text-gray-800 space-y-1">{meta.assumptions.map((s,i)=> <li key={'a'+i}>{s}</li>)}</ul>
                            <div className="mt-2 text-[12px] text-gray-600">Triggersï¼š</div>
                            <ul className="mt-1 list-disc pl-4 text-[12px] text-gray-800 space-y-1">{meta.triggers.map((s,i)=> <li key={'t'+i}>{s}</li>)}</ul>
                          </details>
                        </div>
                      )}
                    ]} />
                  </Section>

                  <Section title="Adaptation" subtitle="è³ªç–‘ â†’ è‡ªå‹•å†é©—è­‰ / ç­–ç•¥åˆ‡æ› (fâ€²(x; g(f(x), Î¸)))" right={<Badge className="bg-amber-600 text-white">å¯æ‰‹å‹•/è‡ªå‹•è§¸ç™¼</Badge>}>
                    <div className="grid md:grid-cols-3 gap-3">
                      <div className="rounded-xl p-3 ring-1 ring-black/5 bg-white/70">
                        <p className="text-xs text-gray-500">ç­–ç•¥</p>
                        <p className="text-sm font-medium text-gray-900 mt-0.5">{meta.reasons[0].title.includes('é‡æ–°') ? 'å¤šä¾†æºäº¤å‰æ¯”å° + æ™‚é–“çª—çµ±ä¸€' : 'åˆæ­¥è³‡æ–™åŒ¯æ•´'}</p>
                      </div>
                      <div className="rounded-xl p-3 ring-1 ring-black/5 bg-white/70">
                        <p className="text-xs text-gray-500">å»ºè­°</p>
                        <p className="text-sm font-medium text-gray-900 mt-0.5">{meta.conf < 0.6 ? 'å»ºè­°å†æ„ŸçŸ¥/äººå¯©' : 'å¯æ¥å—ï¼Œè‹¥éœ€å¯å†é©—è­‰'}</p>
                      </div>
                      <div className="rounded-xl p-3 ring-1 ring-black/5 bg-white/70">
                        <p className="text-xs text-gray-500">ç‰ˆæœ¬</p>
                        <p className="text-sm font-medium text-gray-900 mt-0.5">v{version}</p>
                      </div>
                    </div>
                    <div className="mt-3 rounded-xl bg-amber-50 ring-1 ring-amber-200 p-3 text-xs text-amber-900">
                      <p className="font-medium">æ›´æ­£èªªæ˜</p>
                      <p className="mt-1">{meta.reflection}</p>
                    </div>
                  </Section>

                  <Section title="Reflection" subtitle="ç³»çµ±è‡ªè©•ï¼ˆmeta-summaryï¼‰">
                    <div className="grid sm:grid-cols-3 gap-3">
                      <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                        <p className="text-xs text-gray-500">Self-confidence</p>
                        <p className="text-lg font-semibold text-gray-900">{Math.round(meta.conf * 100)}%</p>
                        <p className="text-[11px] text-gray-600">å·²æ ¡æº–ï¼›ç•¶ä¿¡å¿ƒ &lt; 60% å°‡å»ºè­°å†æ„ŸçŸ¥</p>
                      </div>
                      <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                        <p className="text-xs text-gray-500">Trigger Rules</p>
                        <ul className="mt-1 text-[12px] text-gray-700 list-disc pl-4 space-y-1">
                          <li>ä¾†æºå·®ç•° &gt; 1.5Â°C â†’ Reâ€‘perceive</li>
                          <li>Confidence &lt; 0.6 â†’ Verify + Humanâ€‘inâ€‘loop</li>
                          <li>å¹´ä»½ä¸ä¸€è‡´ â†’ çµ±ä¸€æ™‚é–“çª—</li>
                        </ul>
                      </div>
                      <div className="rounded-xl ring-1 ring-black/5 p-3 bg-white/70">
                        <p className="text-xs text-gray-500">Next Actions</p>
                        <div className="mt-1 flex flex-wrap gap-2">
                          <button onClick={send} disabled={isStreaming} className={`rounded-lg px-2.5 py-1 text-[12px] font-medium text-white ${isStreaming ? 'bg-gray-400' : 'bg-slate-900 hover:bg-slate-800'}`}>å†å•ä¸€é¡Œ</button>
                          <button onClick={challenge} disabled={isStreaming} className={`rounded-lg px-2.5 py-1 text-[12px] font-medium text-white ${isStreaming ? 'bg-gray-400' : 'bg-amber-600 hover:bg-amber-700'}`}>æŒ‘æˆ°æ­¤å›åˆ</button>
                          <button className="rounded-lg px-2.5 py-1 text-[12px] font-medium bg-emerald-600 text-white hover:bg-emerald-700">åŒ¯å‡ºå ±å‘Š</button>
                        </div>
                      </div>
                    </div>
                  </Section>
                </>
              ) : (
                <Section title="TRAP é¢æ¿" subtitle="é¸æ“‡å·¦å´ AI çš„ä¸€å‰‡è¨Šæ¯ä»¥æª¢è¦–å…¶å…ƒèªçŸ¥ç´°ç¯€" right={<Badge className="bg-slate-900 text-white">å¾…é¸æ“‡</Badge>}>
                  <p className="text-sm text-gray-700">é»é¸å°è©±ä¸­çš„ AI å›åˆï¼Œå³å¯åœ¨é€™è£¡çœ‹åˆ° Perception / Reasoning / Transparency / Adaptation / Reflectionã€‚</p>
                </Section>
              )}

              <footer className="text-[11px] text-gray-500">
                <p>æ­¤ç¤ºç¯„ç¶²ç«™ä¸é€£ç¶²ã€ä¸ä½¿ç”¨çœŸå¯¦ APIï¼›æ‰€æœ‰æ•¸æ“šçš†ç‚ºæ¨¡æ“¬ã€‚Design By NV.JoviChenã€‚</p>
              </footer>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
